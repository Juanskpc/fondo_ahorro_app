<p-panel>

    <ng-template pTemplate="header">
        <img src="{{cdn}}images/financiacion_proy_inverse.svg" alt="" class="icono-lateral">
        &nbsp; <span class="text-white">Listado de préstamos </span>
    </ng-template>

    <div class="row">
        <div class="col-sm-12 col-md-6 col-lg-8 pull-right d-flex justify-content-end">
            <button type="button" class="btn btn-success" (click)="agregarPrestamo()">
                <img src="{{cdn}}images/plan_desarrollo_inverse.svg" alt="" class="icono-lateral">
                Agregar nuevo préstamo
            </button>
        </div>

        <div class="col-sm-12 col-md-6 col-lg-4">
            <input type="text" class="form-control" placeholder="Buscar por nombre / cédula">
        </div>
    </div>

    <br>

    <p-table [value]="lstPrestamos">
        <ng-template pTemplate="header">
            <tr>
                <th class="text-center">#</th>
                <th>Nombre asociado</th>
                <th>Valor (interés)</th>
                <th>Fecha inicio del préstamo</th>
                <th>Descripción</th>
                <th>Estado</th>
                <th class="text-center">Opciones</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-prestamo let-rowIndex="rowIndex">
            <tr>
                <td class="text-center">{{rowIndex + 1}}</td>
                <td>{{prestamo.AsociPersona.GenerPersona.primer_nombre}}
                    {{prestamo.AsociPersona.GenerPersona.primer_apellido}}</td>
                <td>{{'$' + (prestamo.valor_prestamo | number:'1.0-0')}} ({{prestamo.interes}}%)</td>
                <td>{{prestamo.fecha_inicio | date: 'fullDate'}}</td>
                <td>{{prestamo.descripcion ? prestamo.descripcion : 'Sin descripción'}}</td>
                <td class="text-center">
                    <p-tag severity="success" value="ACTIVO" [rounded]="true" *ngIf="prestamo.estado == 'A'" />
                    <p-tag severity="secondary" value="FINALIZADO" [rounded]="true" *ngIf="prestamo.estado == 'P'" />
                    <p-tag severity="info" value="SIN DEFINIR" [rounded]="true"
                        *ngIf="prestamo.estado != 'P' && prestamo.estado != 'A'" />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-success" pTooltip="Ver datos"
                        (click)="verDatosPrestamo(prestamo)">
                        <img src="{{cdn}}images/ver_blanco.svg" alt="" class="icono-lateral">
                    </button>
                    &nbsp;
                    <button type="button" class="btn btn-danger" pTooltip="Eliminar"
                        (click)="eliminarPrestamo(prestamo)">
                        <img src="{{cdn}}images/eliminar.svg" alt="" class="icono-lateral">
                    </button>
                    &nbsp;
                    <button type="button" class="btn btn-secondary" pTooltip="Abonar cuota"
                        (click)="abonarCuota(prestamo)">
                        <img src="{{cdn}}images/Identificacion_proyecto_inverse.svg" alt="" class="icono-lateral">
                    </button>
                </td>
            </tr>
        </ng-template>
    </p-table>

</p-panel>

<p-dialog header="Datos del préstamo" [(visible)]="mostrarDatosPrestamo" [modal]="true" [style]="{ width: '50vw' }"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }">

    <span class="text-secondary mb-5">
        A continuación se puede visualizar los datos del préstamo de
        {{prestamoSelect?.AsociPersona?.GenerPersona?.primer_nombre}}
        {{prestamoSelect?.AsociPersona?.GenerPersona?.primer_apellido}}.
    </span>

    <form [formGroup]="frmPrestamo">

        <div class="row">
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Valor del préstamo</label>
                <input type="number" formControlName="valor_prestamo" class="form-control"
                    (blur)="previsualizarPrestamo()"
                    [ngClass]="{ 'is-invalid': (prestamo['valor_prestamo'].touched || submitted) && prestamo['valor_prestamo'].errors }">

                <div *ngIf="prestamo['valor_prestamo'].errors && (prestamo['valor_prestamo'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['valor_prestamo'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Interés (%)</label>
                <input type="number" formControlName="interes" class="form-control" (blur)="previsualizarPrestamo()"
                    [ngClass]="{ 'is-invalid': (prestamo['interes'].touched || submitted) && prestamo['interes'].errors }">

                <div *ngIf="prestamo['interes'].errors && (prestamo['interes'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['interes'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Fecha inicial</label>
                <input type="date" formControlName="fecha_inicio" class="form-control"
                    [ngClass]="{ 'is-invalid': (prestamo['fecha_inicio'].touched || submitted) && prestamo['fecha_inicio'].errors }">

                <div *ngIf="prestamo['fecha_inicio'].errors && (prestamo['fecha_inicio'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['fecha_inicio'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Cuotas</label>
                <input type="number" formControlName="cuotas" class="form-control" (blur)="previsualizarPrestamo()"
                    [ngClass]="{ 'is-invalid': (prestamo['cuotas'].touched || submitted) && prestamo['cuotas'].errors }">

                <div *ngIf="prestamo['cuotas'].errors && (prestamo['cuotas'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['cuotas'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Descripción</label>
                <input type="text" formControlName="descripcion" class="form-control">
            </div>
        </div>
    </form>
</p-dialog>

<p-dialog header="Abonar cuota" [(visible)]="mostrarAbonarCuota" [modal]="true" [style]="{ width: '50vw' }"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }">

    <span class="text-secondary mb-5">
        A continuación se puede visualizar los datos del préstamo de
        {{prestamoSelect?.AsociPersona?.GenerPersona?.primer_nombre}}
        {{prestamoSelect?.AsociPersona?.GenerPersona?.primer_apellido}} y sus respectivos abonos.
    </span>

    <div class="row mt-2 mb-2">
        <div class="col-sm-12 col-md-6 col-lg-4 mt-3 text-center">
            <span class="fw-bold">
                <i class="pi pi-credit-card mr-2" style="color: green; margin-right: 0.4rem;"></i>
                Valor préstamo
            </span>
            <span style="display:block;">${{(prestamoSelect?.valor_prestamo | number:'1.0-0')}}</span>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 mt-3 text-center">
            <span class="fw-bold">
                <i class="pi pi-calendar-clock mr-2" style="color: green; margin-right: 0.4rem;"></i>
                Cuotas
            </span>
            <span style="display:block;">{{prestamoSelect?.cuotas}}</span>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 mt-3 text-center">
            <span class="fw-bold">
                <i class="pi pi-info-circle mr-2" style="color: green; margin-right: 0.4rem;"></i>
                Descripción
            </span>
            <span style="display:block;">{{prestamoSelect?.descripcion ? prestamoSelect?.descripcion : 'Sin descripción'}}</span>
        </div>
    </div>

    <form [formGroup]="frmAbono">

        <div class="row mt-3">
            <div class="col-sm-12 col-md-4 col-lg-4 mt-2">
                <label for="">Valor del abono</label>
                <input type="number" formControlName="valor_abono" class="form-control"
                    [ngClass]="{ 'is-invalid': (abono['valor_abono'].touched || submitted) && abono['valor_abono'].errors }">

                <div *ngIf="abono['valor_abono'].errors && (abono['valor_abono'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="abono['valor_abono'].errors['required']">Campo obligatorio</span>
                </div>
            </div>

            <div class="col-sm-12 col-md-8 col-lg-8 mt-2">
                <label for="">Descripción</label>
                <input type="text" formControlName="descripcion" class="form-control"
                    placeholder="Ej: Cuota junio - Capitál e intereses"
                    [ngClass]="{ 'is-invalid': (abono['descripcion'].touched || submitted) && abono['descripcion'].errors }">

                <div *ngIf="abono['descripcion'].errors && (abono['descripcion'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="abono['descripcion'].errors['required']">Campo obligatorio</span>
                    <span *ngIf="abono['descripcion'].errors['maxlength']">Máximo 30 carácteres</span>
                </div>
            </div>
        </div>

    </form>

    <div class="row mt-3" *ngIf="prestamoSelect?.AsociAbonos.length == 0">
        <div class="col-12 text-center">
            <span class="fw-bold m-3" style="display:block;">
                <i class="pi pi-megaphone mr-2" style="font-size: 3rem; color: gray"></i>
            </span>
            <span style="display:block;">Aún no se han registrado abonos al préstamo</span>
        </div>
    </div>

    <div class="row mt-3" *ngIf="prestamoSelect?.AsociAbonos.length > 0">
        <p-table #dtAb [value]="prestamoSelect.AsociAbonos" styleClass="p-datatable-striped" >
            <ng-template pTemplate="header">
                <tr>
                    <th class="text-center">#</th>
                    <th>Descripción</th>
                    <th>Valor abono</th>
                    <th>Opciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-abono let-i="rowIndex">
                <tr>
                    <td class="text-center">{{i + 1}}</td>
                    <td>{{abono.descripcion}}</td>
                    <td>${{(abono.valor_abono | number: '1.0-0')}}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger" pTooltip="Eliminar"
                            (click)="eliminarAbono(i, abono.id_abono)">
                            <img src="{{cdn}}images/eliminar.svg" alt="" class="icono-lateral">
                        </button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="row pt-5">
        <div class="col-12 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-success" (click)="guardarAbono()">
                <img src="{{cdn}}images/formulacion_proyecto_inverse.svg" alt="" class="icono-lateral">
                Guardar
            </button>

            <button type="button" class="btn btn-danger" (click)="mostrarAbonarCuota = false">
                <img src="{{cdn}}images/plan_desarrollo_inverse.svg" alt="" class="icono-lateral">
                Cerrar
            </button>
        </div>
    </div>
</p-dialog>

<p-dialog header="Nuevo prestamo" [(visible)]="mostrarNuevoPrestamo" [modal]="true" [style]="{ width: '50vw' }"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }">

    <span class="text-secondary mb-5">Ingresa la siguiente información para registrar el préstamo.</span>

    <form [formGroup]="frmPrestamo">

        <div class="row">
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Asociado</label>
                <p-autoComplete formControlName="id_asociado" [suggestions]="lstAsociados"
                    (completeMethod)="buscarAsociadoByNombre($event)" optionLabel="nombre_completo"
                    [ngClass]="{ 'is-invalid': (prestamo['id_asociado'].touched || submitted) && prestamo['id_asociado'].errors }">

                    <ng-template let-asociado pTemplate="item">
                        <div class="flex align-items-center gap-2">
                            <span>{{asociado.nombre_completo}}</span>
                            <hr style="margin: 0% !important;">
                            <span class="fs-6 fst-italic" style="font-size: small !important;">C.C
                                {{asociado.num_identificacion}}</span>
                        </div>
                    </ng-template>

                </p-autoComplete>


                <div *ngIf="prestamo['id_asociado'].errors && (prestamo['id_asociado'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['id_asociado'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Valor del préstamo</label>
                <input type="number" formControlName="valor_prestamo" class="form-control"
                    (blur)="previsualizarPrestamo()"
                    [ngClass]="{ 'is-invalid': (prestamo['valor_prestamo'].touched || submitted) && prestamo['valor_prestamo'].errors }">

                <div *ngIf="prestamo['valor_prestamo'].errors && (prestamo['valor_prestamo'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['valor_prestamo'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Interés (%)</label>
                <input type="number" formControlName="interes" class="form-control" (blur)="previsualizarPrestamo()"
                    [ngClass]="{ 'is-invalid': (prestamo['interes'].touched || submitted) && prestamo['interes'].errors }">

                <div *ngIf="prestamo['interes'].errors && (prestamo['interes'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['interes'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Fecha inicial</label>
                <input type="date" formControlName="fecha_inicio" class="form-control"
                    [ngClass]="{ 'is-invalid': (prestamo['fecha_inicio'].touched || submitted) && prestamo['fecha_inicio'].errors }">

                <div *ngIf="prestamo['fecha_inicio'].errors && (prestamo['fecha_inicio'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['fecha_inicio'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Número de cuotas</label>
                <input type="number" formControlName="cuotas" class="form-control" (blur)="previsualizarPrestamo()"
                    [ngClass]="{ 'is-invalid': (prestamo['cuotas'].touched || submitted) && prestamo['cuotas'].errors }">

                <div *ngIf="prestamo['cuotas'].errors && (prestamo['cuotas'].touched || submitted)"
                    class="form-text text-danger">
                    <span *ngIf="prestamo['cuotas'].errors['required']">Campo obligatorio</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-4 mt-3">
                <label for="">Descripción</label>
                <input type="text" formControlName="descripcion" class="form-control">
            </div>
        </div>
    </form>

    <div class="row pt-3" *ngIf="objPrePrestamo.interes && objPrePrestamo.cuotaMes && objPrePrestamo.totalPagar">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-bg-success text-center">
                    Previsualización del préstamo
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-12 col-md-6 col-lg-4 text-center pt-2">
                            <span class="fw-bold">
                                <i class="pi pi-credit-card mr-2" style="color: green; margin-right: 0.4rem;"></i>
                                Interés
                            </span>
                            <span style="display:block;">${{(objPrePrestamo.interes | number:'1.0-0')}}</span>
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-4 text-center pt-2">
                            <span class="fw-bold">
                                <i class="pi pi-calculator mr-2" style="color: green; margin-right: 0.4rem;"></i>
                                Cuota mensual
                            </span>
                            <span style="display:block;">${{(objPrePrestamo.cuotaMes | number:'1.0-0')}}</span>
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-4 text-center pt-2">
                            <span class="fw-bold">
                                <i class="pi pi-building-columns mr-2" style="color: green; margin-right: 0.4rem;"></i>
                                Total a pagar
                            </span>
                            <span style="display:block;">${{(objPrePrestamo.totalPagar | number:'1.0-0')}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row pt-5">
        <div class="col-12 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-success" (click)="guardarPrestamo()">
                <img src="{{cdn}}images/formulacion_proyecto_inverse.svg" alt="" class="icono-lateral">
                Guardar
            </button>

            <button type="button" class="btn btn-danger" (click)="mostrarNuevoPrestamo = false">
                <img src="{{cdn}}images/plan_desarrollo_inverse.svg" alt="" class="icono-lateral">
                Cerrar
            </button>
        </div>
    </div>
</p-dialog>